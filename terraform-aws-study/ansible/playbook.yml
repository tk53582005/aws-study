---
- hosts: web
  become: yes
  tasks:
    - name: Install Java 21 (Amazon Corretto)
      yum:
        name: java-21-amazon-corretto
        state: present

    - name: Create app directory
      file:
        path: /opt/spring-boot-app
        state: directory
        mode: '0755'

    - name: Copy Spring Boot JAR
      copy:
        src: ../spring-boot-app-jar/app.war
        dest: /opt/spring-boot-app/app.war
        mode: '0644'

    - name: Stop old Spring Boot process
      shell: |
        pkill -f 'app\.war' || true

    - name: Start Spring Boot app
      shell: |
        cd /opt/spring-boot-app
        nohup java -jar app.war > /var/log/spring-boot-app.log 2>&1 &
      async: 10
      poll: 0

    - name: Wait for app to start
      wait_for:
        port: 8080
        delay: 5
        timeout: 60
