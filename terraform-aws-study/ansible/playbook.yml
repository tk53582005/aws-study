---
- hosts: web
  become: yes
  tasks:
    - name: Install rsync
      yum:
        name: rsync
        state: present

    - name: Install Java 21 (Amazon Corretto)
      yum:
        name: java-21-amazon-corretto
        state: present

    - name: Create app directory
      file:
        path: /opt/spring-boot-app
        state: directory
        mode: '0755'

    - name: Copy Spring Boot app
      synchronize:
        src: ../spring-boot-app/
        dest: /opt/spring-boot-app/
        delete: yes
        rsync_opts:
          - "--exclude=.gradle"
          - "--exclude=build"

    - name: Build Spring Boot app
      shell: |
        cd /opt/spring-boot-app
        chmod +x gradlew
        ./gradlew clean build -x test
      args:
        creates: /opt/spring-boot-app/build/libs/*.war

    - name: Stop old Spring Boot process
      shell: |
        pkill -f 'spring-boot-app.*\.war' || true

    - name: Start Spring Boot app
      shell: |
        cd /opt/spring-boot-app
        nohup java -jar build/libs/*.war > /var/log/spring-boot-app.log 2>&1 &
      async: 10
      poll: 0

    - name: Wait for app to start
      wait_for:
        port: 8080
        delay: 5
        timeout: 60
